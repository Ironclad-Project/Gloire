From c569545fe136eac3b4c5cd369639e3a4373b1b32 Mon Sep 17 00:00:00 2001
From: streaksu <assemblyislaw@gmail.com>
Date: Mon, 6 Jun 2022 12:43:32 +0200
Subject: [PATCH] Ironclad specific changes

---
 abis/ironclad/abi.h                           |  29 ++
 abis/ironclad/auxv.h                          |  11 +
 abis/ironclad/seek-whence.h                   |   8 +
 meson.build                                   |   7 +-
 options/ansi/include/inttypes.h               |   2 +
 options/rtdl/generic/main.cpp                 |   2 +-
 sysdeps/ironclad/crt-x86_64/crt0.S            |   7 +
 sysdeps/ironclad/generic/entry.cpp            |  34 ++
 sysdeps/ironclad/generic/generic.cpp          | 413 ++++++++++++++++++
 sysdeps/ironclad/include/abi-bits/abi.h       |   1 +
 sysdeps/ironclad/include/abi-bits/auxv.h      |   1 +
 sysdeps/ironclad/include/abi-bits/blkcnt_t.h  |   1 +
 sysdeps/ironclad/include/abi-bits/blksize_t.h |   1 +
 sysdeps/ironclad/include/abi-bits/dev_t.h     |   1 +
 sysdeps/ironclad/include/abi-bits/errno.h     |   1 +
 sysdeps/ironclad/include/abi-bits/fcntl.h     |   1 +
 sysdeps/ironclad/include/abi-bits/gid_t.h     |   1 +
 sysdeps/ironclad/include/abi-bits/in.h        |   1 +
 sysdeps/ironclad/include/abi-bits/ino_t.h     |   1 +
 sysdeps/ironclad/include/abi-bits/limits.h    |   1 +
 sysdeps/ironclad/include/abi-bits/mode_t.h    |   1 +
 sysdeps/ironclad/include/abi-bits/nlink_t.h   |   1 +
 sysdeps/ironclad/include/abi-bits/pid_t.h     |   1 +
 sysdeps/ironclad/include/abi-bits/reboot.h    |   1 +
 sysdeps/ironclad/include/abi-bits/resource.h  |   1 +
 .../ironclad/include/abi-bits/seek-whence.h   |   1 +
 sysdeps/ironclad/include/abi-bits/signal.h    |   1 +
 sysdeps/ironclad/include/abi-bits/socket.h    |   1 +
 sysdeps/ironclad/include/abi-bits/stat.h      |   1 +
 sysdeps/ironclad/include/abi-bits/termios.h   |   1 +
 sysdeps/ironclad/include/abi-bits/time.h      |   1 +
 sysdeps/ironclad/include/abi-bits/uid_t.h     |   1 +
 sysdeps/ironclad/include/abi-bits/utsname.h   |   1 +
 sysdeps/ironclad/include/abi-bits/vm-flags.h  |   1 +
 sysdeps/ironclad/include/abi-bits/wait.h      |   1 +
 sysdeps/ironclad/include/sys/ironclad.h       |  41 ++
 sysdeps/ironclad/include/sys/syscall.h        |  77 ++++
 sysdeps/ironclad/meson.build                  |  58 +++
 38 files changed, 713 insertions(+), 2 deletions(-)
 create mode 100644 abis/ironclad/abi.h
 create mode 100644 abis/ironclad/auxv.h
 create mode 100644 abis/ironclad/seek-whence.h
 create mode 100644 sysdeps/ironclad/crt-x86_64/crt0.S
 create mode 100644 sysdeps/ironclad/generic/entry.cpp
 create mode 100644 sysdeps/ironclad/generic/generic.cpp
 create mode 120000 sysdeps/ironclad/include/abi-bits/abi.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/auxv.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/blkcnt_t.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/blksize_t.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/dev_t.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/errno.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/fcntl.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/gid_t.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/in.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/ino_t.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/limits.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/mode_t.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/nlink_t.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/pid_t.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/reboot.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/resource.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/seek-whence.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/signal.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/socket.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/stat.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/termios.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/time.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/uid_t.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/utsname.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/vm-flags.h
 create mode 120000 sysdeps/ironclad/include/abi-bits/wait.h
 create mode 100644 sysdeps/ironclad/include/sys/ironclad.h
 create mode 100644 sysdeps/ironclad/include/sys/syscall.h
 create mode 100644 sysdeps/ironclad/meson.build

diff --git a/abis/ironclad/abi.h b/abis/ironclad/abi.h
new file mode 100644
index 00000000..403f7ca3
--- /dev/null
+++ b/abis/ironclad/abi.h
@@ -0,0 +1,29 @@
+#ifndef _ABIBITS_ABI_H
+#define _ABIBITS_ABI_H
+
+// reserve 3 bits for the access mode
+#define __MLIBC_O_ACCMODE 0x0007
+#define __MLIBC_O_RDONLY 1
+#define __MLIBC_O_WRONLY 2
+#define __MLIBC_O_RDWR   3
+#define __MLIBC_O_SEARCH 4
+#define __MLIBC_O_EXEC   7
+
+// This flags are stubs.
+#define __MLIBC_O_APPEND 0x00008
+#define __MLIBC_O_CREAT 0x00010
+#define __MLIBC_O_DIRECTORY 0x00020
+#define __MLIBC_O_EXCL 0x00040
+#define __MLIBC_O_NOCTTY 0x00080
+#define __MLIBC_O_NOFOLLOW 0x00100
+#define __MLIBC_O_TRUNC 0x00200
+#define __MLIBC_O_NONBLOCK 0x00400
+#define __MLIBC_O_DSYNC 0x00800
+#define __MLIBC_O_RSYNC 0x01000
+#define __MLIBC_O_SYNC 0x02000
+#define __MLIBC_O_CLOEXEC 0x04000
+#define __MLIBC_O_PATH 0x08000
+#define __MLIBC_O_LARGEFILE 0x10000
+#define __MLIBC_O_NOATIME 0x20000
+
+#endif // _ABIBITS_ABI_H
diff --git a/abis/ironclad/auxv.h b/abis/ironclad/auxv.h
new file mode 100644
index 00000000..4dc3b4e7
--- /dev/null
+++ b/abis/ironclad/auxv.h
@@ -0,0 +1,11 @@
+#ifndef _ABIBITS_AUXV_H
+#define _ABIBITS_AUXV_H
+
+#define AT_PHDR 3
+#define AT_PHENT 4
+#define AT_PHNUM 5
+#define AT_ENTRY 9
+#define AT_RANDOM 25
+#define AT_EXECFN 31
+
+#endif
diff --git a/abis/ironclad/seek-whence.h b/abis/ironclad/seek-whence.h
new file mode 100644
index 00000000..617b6f41
--- /dev/null
+++ b/abis/ironclad/seek-whence.h
@@ -0,0 +1,8 @@
+#ifndef _ABIBITS_SEEK_WHENCE_H
+#define _ABIBITS_SEEK_WHENCE_H
+
+#define SEEK_SET 1
+#define SEEK_CUR 2
+#define SEEK_END 4
+
+#endif // _ABIBITS_SEEK_WHENCE_H
diff --git a/meson.build b/meson.build
index d3937245..a12963d5 100644
--- a/meson.build
+++ b/meson.build
@@ -1,4 +1,4 @@
-project('mlibc', default_options: ['warning_level=2', 'cpp_std=c++20'])
+project('mlibc', default_options: ['warning_level=2', 'cpp_std=gnu++20'])
 
 fs = import('fs')
 
@@ -117,6 +117,11 @@ elif host_machine.system() == 'qword'
 	rtdl_include_dirs += include_directories('sysdeps/qword/include')
 	libc_include_dirs += include_directories('sysdeps/qword/include')
 	subdir('sysdeps/qword')
+elif host_machine.system() == 'ironclad'
+	# disable_linux_option = true
+	rtdl_include_dirs += include_directories('sysdeps/ironclad/include')
+	libc_include_dirs += include_directories('sysdeps/ironclad/include')
+	subdir('sysdeps/ironclad')
 elif host_machine.system() == 'sigma'
 	#disable_linux_option = true
 	rtdl_include_dirs += include_directories('sysdeps/sigma/include')
diff --git a/options/ansi/include/inttypes.h b/options/ansi/include/inttypes.h
index 50549ae8..d836d991 100644
--- a/options/ansi/include/inttypes.h
+++ b/options/ansi/include/inttypes.h
@@ -102,6 +102,8 @@
 #define SCNd32 "d"
 #define SCNd64 "ld"
 
+#define SCNdMAX "ld"
+
 #ifdef __cplusplus
 extern "C" {
 #endif
diff --git a/options/rtdl/generic/main.cpp b/options/rtdl/generic/main.cpp
index 86c9e00c..73064ac5 100644
--- a/options/rtdl/generic/main.cpp
+++ b/options/rtdl/generic/main.cpp
@@ -175,7 +175,7 @@ extern "C" void *interpreterMain(uintptr_t *entry_stack) {
 	}
 	__ensure(strtab_offset);
 	__ensure(soname_str);
-
+	
 	// Find the auxiliary vector by skipping args and environment.
 	auto aux = entryStack;
 	aux += *aux + 1; // First, we skip argc and all args.
diff --git a/sysdeps/ironclad/crt-x86_64/crt0.S b/sysdeps/ironclad/crt-x86_64/crt0.S
new file mode 100644
index 00000000..0a0a4a0c
--- /dev/null
+++ b/sysdeps/ironclad/crt-x86_64/crt0.S
@@ -0,0 +1,7 @@
+
+.section .text
+.global _start
+_start:
+    mov $main, %rdi
+    call __mlibc_entry
+
diff --git a/sysdeps/ironclad/generic/entry.cpp b/sysdeps/ironclad/generic/entry.cpp
new file mode 100644
index 00000000..ee7a794b
--- /dev/null
+++ b/sysdeps/ironclad/generic/entry.cpp
@@ -0,0 +1,34 @@
+
+#include <stdint.h>
+#include <stdlib.h>
+#include <bits/ensure.h>
+#include <mlibc/elf/startup.h>
+
+// defined by the POSIX library
+void __mlibc_initLocale();
+
+extern "C" uintptr_t *__dlapi_entrystack();
+
+extern char **environ;
+static mlibc::exec_stack_data __mlibc_stack_data;
+
+struct LibraryGuard {
+	LibraryGuard();
+};
+
+static LibraryGuard guard;
+
+LibraryGuard::LibraryGuard() {
+	__mlibc_initLocale();
+
+	// Parse the exec() stack.
+	mlibc::parse_exec_stack(__dlapi_entrystack(), &__mlibc_stack_data);
+	mlibc::set_startup_data(__mlibc_stack_data.argc, __mlibc_stack_data.argv,
+			__mlibc_stack_data.envp);
+}
+
+extern "C" void __mlibc_entry(int (*main_fn)(int argc, char *argv[], char *env[])) {
+	auto result = main_fn(__mlibc_stack_data.argc, __mlibc_stack_data.argv, environ);
+	exit(result);
+}
+
diff --git a/sysdeps/ironclad/generic/generic.cpp b/sysdeps/ironclad/generic/generic.cpp
new file mode 100644
index 00000000..7e00fcd0
--- /dev/null
+++ b/sysdeps/ironclad/generic/generic.cpp
@@ -0,0 +1,413 @@
+#include <bits/ensure.h>
+#include <mlibc/debug.hpp>
+#include <mlibc/all-sysdeps.hpp>
+#include <errno.h>
+#include <dirent.h>
+#include <fcntl.h>
+#include <limits.h>
+#include <asm/ioctls.h>
+#include <stdlib.h>
+#include <string.h>
+#include <stdio.h>
+#include <sys/syscall.h>
+
+#define STUB_ONLY { __ensure(!"STUB_ONLY function was called"); __builtin_unreachable(); }
+
+namespace mlibc {
+
+void sys_libc_log(const char *message) {
+   /*
+	ssize_t unused;
+	char new_line = '\n';
+	sys_write(1, message, strlen(message), &unused);
+	sys_write(1, &new_line, 1, &unused);
+   */
+}
+
+void sys_libc_panic() {
+	ssize_t unused;
+	char *message = "mlibc panicked unrecoverably\n";
+	sys_write(1, message, strlen(message), &unused);
+	sys_exit(1);
+}
+
+void sys_exit(int status) {
+	int ret, errno;
+	SYSCALL1(SYSCALL_EXIT, status);
+}
+
+int sys_tcb_set(void *pointer) {
+	int ret, errno;
+	SYSCALL1(SYSCALL_SET_TCB, pointer);
+	return errno;
+}
+
+int sys_open(const char *path, int flags, int *fd) {
+	int ret, errno;
+	SYSCALL2(SYSCALL_OPEN, path, flags);
+	*fd = ret;
+	return errno;
+}
+
+int sys_open_dir(const char *path, int *handle) {
+	return sys_open(path, O_RDONLY, handle);
+}
+
+int sys_close(int fd) {
+	int ret, errno;
+	SYSCALL1(SYSCALL_CLOSE, fd);
+	return errno;
+}
+
+int sys_read(int fd, void *buf, size_t count, ssize_t *bytes_read) {
+	ssize_t ret;
+	int errno;
+	SYSCALL3(SYSCALL_READ, fd, buf, count);
+	*bytes_read = ret;
+	return errno;
+}
+
+int sys_write(int fd, const void *buf, size_t count, ssize_t *bytes_written) {
+	ssize_t ret;
+	int errno;
+	SYSCALL3(SYSCALL_WRITE, fd, buf, count);
+	*bytes_written = ret;
+	return errno;
+}
+
+int sys_seek(int fd, off_t offset, int whence, off_t *new_offset) {
+	ssize_t ret;
+	int errno;
+	SYSCALL3(SYSCALL_SEEK, fd, offset, whence);
+	*new_offset = ret;
+	return errno;
+}
+
+int sys_anon_allocate(size_t size, void **pointer) {
+	return sys_vm_map(NULL, size, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_ANON, 0, 0, pointer);
+}
+
+int sys_anon_free(void *pointer, size_t size) {
+	return sys_vm_unmap(pointer, size);
+}
+
+int sys_vm_map(void *hint, size_t size, int prot, int flags, int fd, off_t offset, void **window) {
+	void *ret;
+	int errno;
+	SYSCALL6(SYSCALL_MMAP, hint, size, prot, flags, fd, offset);
+	*window = ret;
+	return errno;
+}
+
+int sys_vm_unmap(void *pointer, size_t size) {
+	int ret;
+	int errno;
+	SYSCALL2(SYSCALL_MUNMAP, pointer, size);
+	if (ret != 0) {
+		return errno;
+	} else {
+		return 0;
+	}
+}
+
+pid_t sys_getpid() {
+	pid_t ret;
+	int errno;
+	SYSCALL0(SYSCALL_GETPID);
+	return ret;
+}
+
+pid_t sys_getppid() {
+	pid_t ret;
+	int errno;
+	SYSCALL0(SYSCALL_GETPPID);
+	return ret;
+}
+
+int sys_sigaction(int signum, const struct sigaction *act, struct sigaction *oldact) {
+	mlibc::infoLogger() << "sigaction() is a stub" << frg::endlog;
+	return 0;
+}
+
+int sys_fcntl(int fd, int request, va_list args, int *result) {
+	mlibc::infoLogger() << "fcntl() is a stub!" << frg::endlog;
+	return 0;
+}
+
+int sys_sigprocmask(int how, const sigset_t *__restrict set, sigset_t *__restrict retrieve) {
+	mlibc::infoLogger() << "sigprocmask() is a stub!" << frg::endlog;
+	return ENOSYS;
+}
+
+int sys_ttyname(int fd, char *buf, size_t size) {
+	mlibc::infoLogger() << "ttyname() is a stub!" << frg::endlog;
+	return ENOSYS;
+}
+
+int sys_setpgid(pid_t pid, pid_t pgid) {
+	mlibc::infoLogger() << "mlibc: " << __func__ << " is a stub!" << frg::endlog;
+	return 0;
+}
+
+int sys_pselect(int num_fds, fd_set *read_set, fd_set *write_set, fd_set *except_set,
+	const struct timespec *timeout, const sigset_t *sigmask, int *num_events) {
+	mlibc::infoLogger() << "mlibc: " << __func__ << " is a stub!\n" << frg::endlog;
+	return 0;
+}
+
+int sys_isatty(int fd) {
+	// TODO: Placeholder.
+	return 0;
+}
+
+uid_t sys_getuid() {
+	mlibc::infoLogger() << "getuid() is a stub" << frg::endlog;
+	return 0;
+}
+
+uid_t sys_geteuid() {
+	mlibc::infoLogger() << "geteuid() is a stub" << frg::endlog;
+	return 0;
+}
+
+gid_t sys_getgid() {
+	mlibc::infoLogger() << "getgid() is a stub" << frg::endlog;
+	return 0;
+}
+
+gid_t sys_getegid() {
+	mlibc::infoLogger() << "getegid() is a stub" << frg::endlog;
+	return 0;
+}
+
+pid_t sys_getpgid(pid_t pid, pid_t *pgid) {
+	mlibc::infoLogger() << "getpgid() is a stub" << frg::endlog;
+	*pgid = 0;
+	return 0;
+}
+
+int sys_clock_get(int clock, time_t *secs, long *nanos) {
+	mlibc::infoLogger() << "clock_get() is a stub" << frg::endlog;
+	return 0;
+}
+
+int sys_execve(const char *path, char *const argv[], char *const envp[]) {
+	int ret, errno;
+
+	SYSCALL3(SYSCALL_EXEC, path, argv, envp);
+
+	if (ret == -1) {
+		return errno;
+    }
+
+	return 0;
+}
+
+int sys_fork(pid_t *child) {
+    pid_t ret;
+    int errno;
+
+    SYSCALL0(SYSCALL_FORK);
+
+    if (ret == -1) {
+        return errno;
+    }
+
+    *child = ret;
+    return 0;
+}
+
+int sys_waitpid(pid_t pid, int *status, int flags, pid_t *ret_pid) {
+	pid_t ret;
+	int errno;
+
+	SYSCALL3(SYSCALL_WAIT, pid, status, flags);
+
+	if (ret == -1) {
+		return errno;
+	}
+
+	*ret_pid = ret;
+	return 0;
+}
+
+int sys_uname(struct utsname *buf) {
+	int ret, errno;
+
+	SYSCALL1(SYSCALL_UNAME, buf);
+
+	if (ret == -1) {
+		return errno;
+	}
+
+	return 0;
+}
+
+int sys_sethostname(const char *buff, size_t size) {
+	int ret, errno;
+
+	SYSCALL2(SYSCALL_SETHOSTNAME, buff, size);
+
+	if (ret == -1) {
+		return errno;
+	}
+
+	return 0;
+}
+
+int sys_getcwd(const char *buff, size_t size) {
+	char* ret;
+	int errno;
+
+	SYSCALL2(SYSCALL_GETCWD, buff, size);
+
+	if (ret == NULL) {
+		return errno;
+	}
+
+	return 0;
+}
+
+int sys_chdir(const char *buff) {
+	int ret, errno;
+
+	SYSCALL1(SYSCALL_CHDIR, buff);
+
+	if (ret == -1) {
+		return errno;
+	}
+
+	return 0;
+}
+
+int sys_ioctl(int fd, unsigned long request, void *arg, int *result) {
+	int ret, errno;
+
+	SYSCALL3(SYSCALL_IOCTL, fd, request, arg);
+
+	if (ret == -1) {
+		return errno;
+	}
+
+   *result = ret;
+	return 0;
+}
+
+int sys_sched_yield(void) {
+	int ret, errno;
+
+	SYSCALL0(SYSCALL_SCHED_YIELD);
+
+	if (ret == -1) {
+		return errno;
+	}
+
+	return 0;
+}
+
+int sys_dup(int fd, int flags, int *newfd) {
+	(void)flags;
+
+	int ret, errno;
+
+	SYSCALL1(SYSCALL_DUP, fd);
+
+	if (ret == -1) {
+        return errno;
+	}
+	*newfd = ret;
+	return 0;
+}
+
+int sys_dup2(int fd, int flags, int newfd) {
+	int ret, errno;
+
+	if (flags) {
+		SYSCALL3(SYSCALL_DUP3, fd, newfd, flags);
+	} else {
+		SYSCALL2(SYSCALL_DUP2, fd, newfd);
+	}
+
+	if (ret == -1) {
+        return errno;
+	} else {
+		return 0;
+	}
+}
+
+int sys_tcgetattr(int fd, struct termios *attr) {
+    int ret;
+
+    if (int r = sys_ioctl(fd, TCGETS, attr, &ret) != 0) {
+        return r;
+    }
+
+    return 0;
+}
+
+int sys_tcsetattr(int fd, int optional_action, const struct termios *attr) {
+    int ret;
+
+    switch (optional_action) {
+        case TCSANOW:
+            optional_action = TCSETS; break;
+        case TCSADRAIN:
+            optional_action = TCSETSW; break;
+        case TCSAFLUSH:
+            optional_action = TCSETSF; break;
+        default:
+            __ensure(!"Unsupported tcsetattr");
+    }
+
+    if (int r = sys_ioctl(fd, optional_action, (void *)attr, &ret) != 0) {
+        return r;
+    }
+
+    return 0;
+}
+
+int sys_futex_wait(int *pointer, int expected, const struct timespec *time) STUB_ONLY
+int sys_futex_wake(int *pointer) STUB_ONLY
+
+#ifndef MLIBC_BUILDING_RTDL
+
+int sys_gethostname(char *buffer, size_t bufsize) {
+	struct utsname buf;
+	if (uname(&buf)) {
+		return -1;
+	}
+
+	strncpy(buffer, buf.nodename, bufsize);
+	return 0;
+}
+
+int sys_stat(fsfd_target fsfdt, int fd, const char *path, int flags, struct stat *statbuf) {
+	int ret, errno;
+
+	switch (fsfdt) {
+		case fsfd_target::fd: {
+			// mlibc wants us to do a fstat.
+			SYSCALL2(SYSCALL_FSTAT, fd, statbuf);
+			return errno;
+		}
+		case fsfd_target::path: {
+			// mlibc wants us to do a lstat.
+			SYSCALL2(SYSCALL_LSTAT, path, statbuf);
+			return errno;
+		}
+		case fsfd_target::fd_path: {
+			// mlibc wants us to do an fstatat
+			__ensure(!"stat: Invalid fstatat");
+			__builtin_unreachable();
+		}
+		default: {
+			__ensure(!"stat: Invalid fsfdt");
+			__builtin_unreachable();
+		}
+	}
+
+	__builtin_unreachable();
+}
+
+#endif
+} // namespace mlibc
diff --git a/sysdeps/ironclad/include/abi-bits/abi.h b/sysdeps/ironclad/include/abi-bits/abi.h
new file mode 120000
index 00000000..b466b4b2
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/abi.h
@@ -0,0 +1 @@
+../../../../abis/ironclad/abi.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/auxv.h b/sysdeps/ironclad/include/abi-bits/auxv.h
new file mode 120000
index 00000000..f9be8994
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/auxv.h
@@ -0,0 +1 @@
+../../../../abis/ironclad/auxv.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/blkcnt_t.h b/sysdeps/ironclad/include/abi-bits/blkcnt_t.h
new file mode 120000
index 00000000..e9d9f1b4
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/blkcnt_t.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/blkcnt_t.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/blksize_t.h b/sysdeps/ironclad/include/abi-bits/blksize_t.h
new file mode 120000
index 00000000..c6dfb6e0
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/blksize_t.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/blksize_t.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/dev_t.h b/sysdeps/ironclad/include/abi-bits/dev_t.h
new file mode 120000
index 00000000..0c1143b9
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/dev_t.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/dev_t.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/errno.h b/sysdeps/ironclad/include/abi-bits/errno.h
new file mode 120000
index 00000000..589859fb
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/errno.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/errno.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/fcntl.h b/sysdeps/ironclad/include/abi-bits/fcntl.h
new file mode 120000
index 00000000..ea5323ad
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/fcntl.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/fcntl.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/gid_t.h b/sysdeps/ironclad/include/abi-bits/gid_t.h
new file mode 120000
index 00000000..6a772180
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/gid_t.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/gid_t.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/in.h b/sysdeps/ironclad/include/abi-bits/in.h
new file mode 120000
index 00000000..b58c683f
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/in.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/in.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/ino_t.h b/sysdeps/ironclad/include/abi-bits/ino_t.h
new file mode 120000
index 00000000..10d644e7
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/ino_t.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/ino_t.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/limits.h b/sysdeps/ironclad/include/abi-bits/limits.h
new file mode 120000
index 00000000..1aa58942
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/limits.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/limits.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/mode_t.h b/sysdeps/ironclad/include/abi-bits/mode_t.h
new file mode 120000
index 00000000..29d77331
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/mode_t.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/mode_t.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/nlink_t.h b/sysdeps/ironclad/include/abi-bits/nlink_t.h
new file mode 120000
index 00000000..7618c27f
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/nlink_t.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/nlink_t.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/pid_t.h b/sysdeps/ironclad/include/abi-bits/pid_t.h
new file mode 120000
index 00000000..3fd26a7f
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/pid_t.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/pid_t.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/reboot.h b/sysdeps/ironclad/include/abi-bits/reboot.h
new file mode 120000
index 00000000..ecc3ddb9
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/reboot.h
@@ -0,0 +1 @@
+../../../../abis/linux/x86_64/reboot.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/resource.h b/sysdeps/ironclad/include/abi-bits/resource.h
new file mode 120000
index 00000000..3e59c750
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/resource.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/resource.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/seek-whence.h b/sysdeps/ironclad/include/abi-bits/seek-whence.h
new file mode 120000
index 00000000..fbd0a8fa
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/seek-whence.h
@@ -0,0 +1 @@
+../../../../abis/ironclad/seek-whence.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/signal.h b/sysdeps/ironclad/include/abi-bits/signal.h
new file mode 120000
index 00000000..b20e5119
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/signal.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/signal.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/socket.h b/sysdeps/ironclad/include/abi-bits/socket.h
new file mode 120000
index 00000000..0e1d6be9
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/socket.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/socket.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/stat.h b/sysdeps/ironclad/include/abi-bits/stat.h
new file mode 120000
index 00000000..82642c3c
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/stat.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/stat.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/termios.h b/sysdeps/ironclad/include/abi-bits/termios.h
new file mode 120000
index 00000000..cfcfe763
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/termios.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/termios.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/time.h b/sysdeps/ironclad/include/abi-bits/time.h
new file mode 120000
index 00000000..97f3d52d
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/time.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/time.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/uid_t.h b/sysdeps/ironclad/include/abi-bits/uid_t.h
new file mode 120000
index 00000000..1113eba6
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/uid_t.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/uid_t.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/utsname.h b/sysdeps/ironclad/include/abi-bits/utsname.h
new file mode 120000
index 00000000..17b993fe
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/utsname.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/utsname.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/vm-flags.h b/sysdeps/ironclad/include/abi-bits/vm-flags.h
new file mode 120000
index 00000000..f1a985e6
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/vm-flags.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/vm-flags.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/abi-bits/wait.h b/sysdeps/ironclad/include/abi-bits/wait.h
new file mode 120000
index 00000000..6d911c7f
--- /dev/null
+++ b/sysdeps/ironclad/include/abi-bits/wait.h
@@ -0,0 +1 @@
+../../../../abis/mlibc/wait.h
\ No newline at end of file
diff --git a/sysdeps/ironclad/include/sys/ironclad.h b/sysdeps/ironclad/include/sys/ironclad.h
new file mode 100644
index 00000000..a904870f
--- /dev/null
+++ b/sysdeps/ironclad/include/sys/ironclad.h
@@ -0,0 +1,41 @@
+#ifndef _IRONCLAD_H
+#define _IRONCLAD_H
+
+#include <stdint.h>
+#include <stdbool.h>
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+#define FB_DIMENSIONS 1
+
+struct ironclad_fb_dimensions {
+   uint16_t width;
+   uint16_t height;
+   uint16_t pitch;
+   uint16_t bpp;
+   uint8_t  red_mask_size;
+   uint8_t  red_mask_shift;
+   uint8_t  green_mask_size;
+   uint8_t  green_mask_shift;
+   uint8_t  blue_mask_size;
+   uint8_t  blue_mask_shift;
+};
+
+#define PS2MOUSE_2_1_SCALING     1
+#define PS2MOUSE_1_1_SCALING     2
+#define PS2MOUSE_SET_RES         3
+#define PS2MOUSE_SET_SAMPLE_RATE 4
+
+struct ironclad_mouse_data {
+   int  x_variation;
+   int  y_variation;
+   bool is_left;
+   bool is_right;
+};
+#ifdef __cplusplus
+}
+#endif
+
+#endif // _IRONCLAD_H
diff --git a/sysdeps/ironclad/include/sys/syscall.h b/sysdeps/ironclad/include/sys/syscall.h
new file mode 100644
index 00000000..7dc32772
--- /dev/null
+++ b/sysdeps/ironclad/include/sys/syscall.h
@@ -0,0 +1,77 @@
+#ifndef _SYSCALL_H
+#define _SYSCALL_H
+
+#define SYSCALL0(NUM) ({                   \
+	asm volatile ("int $0x80"              \
+				  : "=a"(ret), "=d"(errno) \
+				  : "a"(NUM)               \
+				  : "memory");             \
+})
+
+#define SYSCALL1(NUM, ARG0) ({             \
+	asm volatile ("int $0x80"              \
+				  : "=a"(ret), "=d"(errno) \
+				  : "a"(NUM), "D"(ARG0)    \
+				  : "memory");             \
+})
+
+#define SYSCALL2(NUM, ARG0, ARG1) ({               \
+	asm volatile ("int $0x80"                      \
+				  : "=a"(ret), "=d"(errno)         \
+				  : "a"(NUM), "D"(ARG0), "S"(ARG1) \
+				  : "memory");                     \
+})
+
+#define SYSCALL3(NUM, ARG0, ARG1, ARG2) ({                    \
+	asm volatile ("int $0x80"                                 \
+				  : "=a"(ret), "=d"(errno)                    \
+				  : "a"(NUM), "D"(ARG0), "S"(ARG1), "d"(ARG2) \
+				  : "memory");                                \
+})
+
+#define SYSCALL4(NUM, ARG0, ARG1, ARG2, ARG3) ({             \
+	asm volatile ("int $0x80"                                 \
+				  : "=a"(ret), "=d"(errno)                    \
+				  : "a"(NUM), "D"(ARG0), "S"(ARG1), "d"(ARG2), "c"(ARG3) \
+				  : "memory");                                \
+})
+
+#define SYSCALL6(NUM, ARG0, ARG1, ARG2, ARG3, ARG4, ARG5) ({   \
+	register typeof(ARG4) arg_r8 asm("r8") = ARG4;             \
+	register typeof(ARG5) arg_r9 asm("r9") = ARG5;             \
+	asm volatile ("int $0x80"                                  \
+				  : "=a"(ret), "=d"(errno)                     \
+				  : "a"(NUM), "D"(ARG0), "S"(ARG1), "d"(ARG2), \
+					"c"(ARG3), "r"(arg_r8), "r"(arg_r9)        \
+				  : "memory");                                 \
+})
+
+#define SYSCALL_EXIT               0
+#define SYSCALL_SET_TCB            1
+#define SYSCALL_OPEN               2
+#define SYSCALL_CLOSE              3
+#define SYSCALL_READ               4
+#define SYSCALL_WRITE              5
+#define SYSCALL_SEEK               6
+#define SYSCALL_MMAP               7
+#define SYSCALL_MUNMAP             8
+#define SYSCALL_GETPID             9
+#define SYSCALL_GETPPID           10
+#define SYSCALL_EXEC              11
+#define SYSCALL_FORK              12
+#define SYSCALL_WAIT              13
+#define SYSCALL_UNAME             14
+#define SYSCALL_SETHOSTNAME       15
+#define SYSCALL_FSTAT             16
+#define SYSCALL_LSTAT             17
+#define SYSCALL_GETCWD            18
+#define SYSCALL_CHDIR             19
+#define SYSCALL_IOCTL             20
+#define SYSCALL_SCHED_YIELD       21
+#define SYSCALL_GETPRIORITY       22
+#define SYSCALL_SETPRIORITY       23
+#define SYSCALL_DUP               24
+#define SYSCALL_DUP2              25
+#define SYSCALL_DUP3              26
+
+#endif // _SYSCALL_H
diff --git a/sysdeps/ironclad/meson.build b/sysdeps/ironclad/meson.build
new file mode 100644
index 00000000..26cd7ad7
--- /dev/null
+++ b/sysdeps/ironclad/meson.build
@@ -0,0 +1,58 @@
+
+rtdl_sources += files(
+	'generic/generic.cpp'
+)
+
+libc_sources += files(
+	'generic/entry.cpp',
+	'generic/generic.cpp'
+)
+
+if not no_headers
+	install_headers(
+		'include/abi-bits/abi.h',
+		'include/abi-bits/auxv.h',
+		'include/abi-bits/seek-whence.h',
+		'include/abi-bits/vm-flags.h',
+		'include/abi-bits/errno.h',
+		'include/abi-bits/fcntl.h',
+		'include/abi-bits/in.h',
+		'include/abi-bits/reboot.h',
+		'include/abi-bits/resource.h',
+		'include/abi-bits/stat.h',
+		'include/abi-bits/signal.h',
+		'include/abi-bits/socket.h',
+		'include/abi-bits/termios.h',
+		'include/abi-bits/time.h',
+		'include/abi-bits/blkcnt_t.h',
+		'include/abi-bits/blksize_t.h',
+		'include/abi-bits/dev_t.h',
+		'include/abi-bits/gid_t.h',
+		'include/abi-bits/ino_t.h',
+		'include/abi-bits/mode_t.h',
+		'include/abi-bits/nlink_t.h',
+		'include/abi-bits/pid_t.h',
+		'include/abi-bits/uid_t.h',
+		'include/abi-bits/wait.h',
+		'include/abi-bits/limits.h',
+      'include/abi-bits/utsname.h',
+		subdir: 'abi-bits'
+	)
+	install_headers(
+		'include/sys/ironclad.h',
+		'include/sys/syscall.h',
+		subdir: 'sys'
+	)
+endif
+
+if not headers_only
+	crt = custom_target('crt0',
+		build_by_default: true,
+		command: c_compiler.cmd_array() + ['-c', '-o', '@OUTPUT@', '@INPUT@'],
+		input: 'crt-x86_64/crt0.S',
+		output: 'crt0.o',
+		install: true,
+		install_dir: get_option('libdir')
+	)
+endif
+
-- 
2.36.1

