#! /bin/sh

name=nspr
version=4.37
revision=1
tarball_url="https://archive.mozilla.org/pub/nspr/releases/v${version}/src/nspr-${version}.tar.gz"
tarball_blake2b="672c07a00db9a9f1fe113aedbee748477b7081c7c6b87efdda1eb8a69b37da661d56eb5a5b2b438cdcd193358e25a277a5ffa43ca274a1894bba718cd05bb2e4"
imagedeps="build-essential gcc"
hostdeps="gcc pkg-config"
deps="core-libs"

prepare() {
    # Disable two unneeded scripts
    sed -i '/^RELEASE/s|^|#|' ${source_dir}/nspr/pr/src/misc/Makefile.in
    # Disable static libraries
    sed -i 's|$(LIBRARY) ||'  ${source_dir}/nspr/config/rules.mk

    autotools_recursive_regen
}

configure() {
        CROSS_COMPILE=1 \
        configure_script_path="${source_dir}/nspr/configure" \
    autotools_configure \
        --enable-optimize \
        --with-mozilla \
        --with-pthreads \
        --enable-64bit \
        --build=x86_64-linux \
        --host=x86_64-linux
}

build() {
    # Build a native nsinstall to use during the build
    make CC=gcc CXX=g++ -C config/ -j${parallelism}
    mv -v config/nsinstall config/native-nsinstall
    sed -s 's#/nsinstall$#/native-nsinstall#' -i config/autoconf.mk
    rm -v config/nsinstall.o
    make CC=${OS_TRIPLET}-gcc CXX=${OS_TRIPLET}-g++ -j${parallelism}
}

package() {
    DESTDIR="${dest_dir}" make install

    post_package_strip
}
