#! /bin/sh

name=mlibc
skip_pkg_check=yes
version=0.0git
revision=24
git_url="https://github.com/managarm/mlibc.git"
commit=e435d34da5b3e8c56bc7dd44bbb6dcbedc998327
hostdeps="gcc pkg-config"
deps="mlibc-headers"

early_prepare() {
    # Fix the subproject commits
    sed -i 's/revision = .*/revision = 5304639c1c9fd3713fd759453b0415b968dcaa06/g' subprojects/frigg.wrap
    sed -i 's/revision = .*/revision = 4039f438fb1dc1064d8e98f70e1cf122f91b763b/g' subprojects/freestnd-c-hdrs.wrap
    sed -i 's/revision = .*/revision = 85096df5361a4d7ef2ce46947e555ec248c2858e/g' subprojects/freestnd-cxx-hdrs.wrap

    meson subprojects download

    curl -Lo libgcc.a https://github.com/osdev0/libgcc-binaries/releases/download/2025-08-21/libgcc-${JINX_ARCH}.a
    case "${JINX_ARCH}" in
        x86_64)
            b2sum libgcc.a | grep -q f41054803d2c8475ca394b37e4368aa7ae900bb73409f3d9566b4348797a16efadc97e28ed5db1432c30ba8c4b5ae8fb5ff42ec6d77c2f749765cac89bd66b56
            ;;
        riscv64)
            b2sum libgcc.a | grep -q f0076a3e36f34fff8c7186e9379940747f009a73d71e88a9f33a29dd7d1993ae01d800187e86510249e7043c2ab24b07a2249f2a985a55af6e1a2fcdf029665b
            ;;
    esac
}

configure() {
        CFLAGS="$TARGET_CFLAGS" \
        CXXFLAGS="$TARGET_CXXFLAGS" \
        LDFLAGS="$TARGET_LDFLAGS -Wl,${source_dir}/libgcc.a" \
    meson_configure_noflags \
        --buildtype=release \
        -Dno_headers=true \
        -Ddefault_library=both \
        -Dlibgcc_dependency=false \
        -Duse_freestnd_hdrs=enabled
}

build() {
    meson compile -j${parallelism}
}

package() {
    DESTDIR="${dest_dir}" meson install --no-rebuild
}
